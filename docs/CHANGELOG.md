# 変更履歴

## 2025-10-24 - キャンセル連絡機能の追加

### 概要

予約連絡とキャンセル連絡を区別し、キャンセル連絡時にはカレンダーイベントを削除する機能を追加しました。

### 変更内容

#### 1. ラベル設定の追加 (Code.gs)

- `LABELS` 定数に以下を追加:
  - `reservation: "予約連絡"` - 予約連絡ラベル
  - `cancellation: "キャンセル連絡"` - キャンセル連絡ラベル

#### 2. メール処理フローの分岐 (Code.gs)

**`pollEmails()` 関数の修正:**

- 各メールスレッドに付与されたラベルを確認し、処理を分岐
- 予約連絡の場合:
  - LINE 通知: 「【新着予約】SALON BOARD」で開始（従来通り）
  - カレンダーにイベントを作成（従来通り）
- キャンセル連絡の場合:
  - LINE 通知: 「【キャンセル連絡】SALON BOARD」で開始
  - 簡略化された情報（顧客名と来店日時のみ）を表示
  - カレンダーから該当イベントを検索して削除
- ラベルがない場合:
  - デフォルトで予約として処理（後方互換性のため）

#### 3. 新規関数の追加 (Code.gs)

**`notifyLineCancellation(meta, schedule, customerName)` 関数:**

- キャンセル連絡用の LINE 通知を送信
- 通知フォーマット:
  ```
  【キャンセル連絡】SALON BOARD
  お名前: ○○さま
  日程: YYYY/MM/DD (曜) HH:mm - HH:mm
  ```
- 予約詳細情報（メニュー、クーポンなど）は含めない

**`deleteCalendarEvent(schedule, customerName)` 関数:**

- Google カレンダーから該当イベントを検索して削除
- 検索条件:
  - タイトルに顧客名が含まれている
  - 開始時刻が ±5 分以内で一致
- 検索範囲: 開始時刻の前後 30 分
- 複数見つかった場合は最初の 1 件のみ削除
- 見つからない場合はログに記録（エラーにはしない）

#### 4. ドキュメントの更新

**FUNCTION_DEPENDENCIES.md:**

- 関数依存関係図を更新
- 新規関数 2 つを追加:
  - `notifyLineCancellation()`
  - `deleteCalendarEvent()`
- 統計情報を更新:
  - 合計関数数: 34 個 → 36 個（+2）
  - レベル 1 関数: 10 個 → 12 個（+2）
  - レベル 2 関数: 9 個 → 10 個（+1）

**CHANGELOG.md (本ファイル):**

- 変更履歴を記録

### 技術詳細

#### ラベル判定ロジック

```javascript
const labels = thread.getLabels().map((label) => label.getName());
const isReservation = labels.includes(LABELS.reservation);
const isCancellation = labels.includes(LABELS.cancellation);
```

#### カレンダーイベント削除ロジック

1. 開始時刻の前後 30 分の範囲でイベントを検索
2. タイトルに顧客名が含まれるイベントをフィルタリング
3. 開始時刻が ±5 分以内で一致するイベントを削除
4. 最初に見つかった 1 件のみを削除（重複削除を防止）

### 運用上の注意点

1. **Gmail ラベルの設定**

   - `予約連絡` と `キャンセル連絡` のラベルは Gmail 側で事前に作成・付与されている必要があります
   - ラベルがない場合は、デフォルトで予約として処理されます

2. **カレンダーイベント削除の仕様**

   - 顧客名と来店日時が一致するイベントを削除します
   - 時刻の誤差は ±5 分まで許容されます
   - 該当イベントが見つからない場合でもエラーにはなりません（ログに記録のみ）

3. **後方互換性**
   - ラベルがない既存のメールは予約として処理されます
   - 既存の予約処理フローには影響がありません

### テスト推奨項目

1. キャンセル連絡ラベル付きメールの処理
2. 予約連絡ラベル付きメールの処理
3. ラベルなしメールの処理（デフォルト動作）
4. カレンダーイベントの削除確認
5. 該当イベントが見つからない場合の動作

### 影響を受けるファイル

- `/Users/max/Projects/bsl-line-reminder/Code.gs` - メインロジック
- `/Users/max/Projects/bsl-line-reminder/FUNCTION_DEPENDENCIES.md` - ドキュメント更新
- `/Users/max/Projects/bsl-line-reminder/CHANGELOG.md` - 本ファイル（新規作成）
